```markdown
# Vulnerabilidade de Format String em Funções `printf` (C/C++)

A vulnerabilidade de **format string** é uma das falhas clássicas de corrupção de memória em softwares escritos em C e C++. Ela ocorre quando funções de formatação de saída, como `printf`, `fprintf`, `sprintf`, `snprintf`, entre outras, recebem como argumento de formato uma string controlada pelo usuário, sem a devida validação. Essa falha pode permitir desde a leitura de dados sensíveis da memória até a execução arbitrária de código.

## Como Funciona a Vulnerabilidade

Funções da família `printf` utilizam uma string de formato para determinar como os argumentos subsequentes devem ser interpretados e exibidos. Por exemplo:

```c
printf("Valor: %d\n", valor);
```

Se, por descuido, o programador passar uma string controlada pelo usuário diretamente como formato, como no exemplo abaixo, abre-se uma brecha de segurança:

```c
char buffer[100];
scanf("%99s", buffer);
printf(buffer); // VULNERÁVEL!
```

Se o usuário inserir, por exemplo, `%x %x %x %x`, a função `printf` tentará ler valores da pilha e exibi-los como inteiros em hexadecimal, podendo vazar informações sensíveis.

## Exemplos Práticos

### 1. Vazamento de Dados da Pilha

Considere o seguinte código:

```c
#include <stdio.h>

int main() {
    char nome[100];
    printf("Digite seu nome: ");
    scanf("%99s", nome);
    printf(nome); // Uso inseguro!
    return 0;
}
```

Se o usuário digitar:  
```
%08x %08x %08x %08x
```
A saída será algo como:
```
bffff7c0 00000000 00000001 b7fd7ff4
```
Esses valores são dados da pilha, que podem incluir endereços, variáveis locais, ponteiros, etc.

### 2. Escrita Arbitrária na Memória

Além de ler, é possível escrever na memória usando o especificador `%n`, que faz com que `printf` escreva o número de caracteres impressos até o momento em um endereço fornecido como argumento. Se o atacante conseguir manipular a pilha para que um ponteiro controlado por ele seja usado, pode sobrescrever valores críticos, como ponteiros de função ou endereços de retorno.

Exemplo ilustrativo:

```c
#include <stdio.h>

int main() {
    int alvo = 0;
    printf("Digite algo: ");
    char input[100];
    fgets(input, sizeof(input), stdin);
    printf(input); // VULNERÁVEL!
    printf("\nValor de alvo: %d\n", alvo);
    return 0;
}
```

Se o atacante souber o endereço de `alvo` e conseguir posicioná-lo corretamente na pilha, pode usar `%n` para modificar seu valor.

## Impactos

- **Vazamento de informações sensíveis** (endereços, senhas, chaves, etc.)
- **Execução de código arbitrário** (em casos avançados, combinando com outras técnicas)
- **Modificação de variáveis internas** (usando `%n`)
- **Bypass de mecanismos de segurança** (ASLR, DEP, etc.)

## Como Prevenir

- **Nunca** passe strings controladas pelo usuário diretamente como formato para funções da família `printf`.
- Sempre use um formato fixo e passe a string do usuário como argumento:

    ```c
    printf("%s", buffer); // Seguro
    ```

- Ferramentas de análise estática e compiladores modernos podem emitir alertas para usos inseguros de funções de formatação.
- Considere o uso de funções mais seguras, como `snprintf`, e sempre valide/limite o tamanho das entradas.

## Referências

- [CWE-134: Use of Externally-Controlled Format String](https://cwe.mitre.org/data/definitions/134.html)
- [OWASP: Format String Attack](https://owasp.org/www-community/attacks/Format_string_attack)
- [The Art of Exploitation, Jon Erickson, 2nd Edition](https://www.nostarch.com/hacking2.htm)

---

A vulnerabilidade de format string é um exemplo clássico de como a manipulação descuidada de funções de baixo nível em C/C++ pode levar a falhas graves de segurança. O entendimento e a prevenção desse tipo de bug são essenciais para o desenvolvimento de softwares robustos e seguros.
```
